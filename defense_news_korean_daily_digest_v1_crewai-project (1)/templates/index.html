<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ì‚° ë‰´ìŠ¤ í•œêµ­ì–´ ì¼ì¼ ë‹¤ì´ì œìŠ¤íŠ¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1923;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* í—¤ë” */
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }

        header h1 span {
            color: #4fc3f7;
        }

        header p {
            color: #90a4ae;
            font-size: 0.95rem;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            background: #1a2733;
            border: 1px solid #263743;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .run-btn {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: #fff;
            border: none;
            padding: 14px 48px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .run-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(21, 101, 192, 0.4);
        }

        .run-btn:disabled {
            background: #37474f;
            color: #78909c;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ìƒíƒœ í‘œì‹œ */
        .status-bar {
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #546e7a;
        }

        .status-dot.idle { background: #546e7a; }
        .status-dot.running { background: #ffb74d; animation: pulse 1.2s infinite; }
        .status-dot.completed { background: #66bb6a; }
        .status-dot.error { background: #ef5350; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-text {
            color: #90a4ae;
        }

        .time-info {
            color: #607d8b;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner-area {
            display: none;
            margin-top: 20px;
        }

        .spinner-area.active { display: block; }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            border: 4px solid #263743;
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner-text {
            color: #4fc3f7;
            font-size: 0.9rem;
        }

        /* ê²°ê³¼ ì˜ì—­ */
        .result-section {
            display: none;
        }

        .result-section.visible { display: block; }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .result-header h2 {
            font-size: 1.3rem;
            color: #ffffff;
        }

        .result-badge {
            background: #1b5e20;
            color: #a5d6a7;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .result-content {
            background: #1a2733;
            border: 1px solid #263743;
            border-radius: 12px;
            padding: 30px;
            line-height: 1.85;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 70vh;
            overflow-y: auto;
        }

        .result-content::-webkit-scrollbar {
            width: 6px;
        }

        .result-content::-webkit-scrollbar-track {
            background: #1a2733;
        }

        .result-content::-webkit-scrollbar-thumb {
            background: #37474f;
            border-radius: 3px;
        }

        /* ì—ëŸ¬ í‘œì‹œ */
        .error-box {
            display: none;
            background: #3e1a1a;
            border: 1px solid #5c2626;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            color: #ef9a9a;
        }

        .error-box.visible { display: block; }

        .error-box h3 {
            color: #ef5350;
            margin-bottom: 8px;
        }

        /* ì´ë©”ì¼ ì „ì†¡ ì„¹ì…˜ */
        .email-section {
            display: none;
            background: #1a2733;
            border: 1px solid #263743;
            border-radius: 12px;
            padding: 24px 30px;
            margin-top: 20px;
        }

        .email-section.visible { display: block; }

        .email-section h3 {
            color: #ffffff;
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        .email-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .email-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #37474f;
            border-radius: 8px;
            background: #0f1923;
            color: #e0e0e0;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .email-input:focus {
            border-color: #4fc3f7;
        }

        .email-input::placeholder {
            color: #546e7a;
        }

        .email-btn {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: #fff;
            border: none;
            padding: 12px 28px;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .email-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #388e3c, #2e7d32);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(46, 125, 50, 0.4);
        }

        .email-btn:disabled {
            background: #37474f;
            color: #78909c;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .email-msg {
            margin-top: 12px;
            font-size: 0.9rem;
            display: none;
            padding: 10px 14px;
            border-radius: 8px;
        }

        .email-msg.visible { display: block; }

        .email-msg.success {
            background: #1b3a1b;
            border: 1px solid #2e7d32;
            color: #a5d6a7;
        }

        .email-msg.fail {
            background: #3e1a1a;
            border: 1px solid #5c2626;
            color: #ef9a9a;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 600px) {
            header h1 { font-size: 1.4rem; }
            .control-panel { padding: 20px; }
            .run-btn { padding: 12px 32px; font-size: 1rem; }
            .result-content { padding: 20px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›¡ï¸ ë°©ì‚° ë‰´ìŠ¤ <span>í•œêµ­ì–´ ì¼ì¼ ë‹¤ì´ì œìŠ¤íŠ¸</span></h1>
            <p>Defense Newsì—ì„œ ì£¼ìš” ê¸°ì‚¬ë¥¼ í¬ë¡¤ë§í•˜ì—¬ í•œêµ­ì–´ë¡œ ì¬ì‘ì„±í•©ë‹ˆë‹¤</p>
        </header>

        <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="control-panel">
            <button class="run-btn" id="runBtn" onclick="startExecution()">
                â–¶ ì‹¤í–‰í•˜ê¸°
            </button>

            <div class="status-bar">
                <div class="status-dot" id="statusDot"></div>
                <span class="status-text" id="statusText">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="time-info" id="timeInfo"></div>

            <div class="spinner-area" id="spinnerArea">
                <div class="spinner"></div>
                <div class="spinner-text">AI ì—ì´ì „íŠ¸ê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤... ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
            </div>
        </div>

        <!-- ì—ëŸ¬ í‘œì‹œ -->
        <div class="error-box" id="errorBox">
            <h3>âš ï¸ ì‹¤í–‰ ì˜¤ë¥˜</h3>
            <p id="errorText"></p>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h2>ğŸ“° ë¶„ì„ ê²°ê³¼</h2>
                <span class="result-badge" id="resultBadge"></span>
            </div>
            <div class="result-content" id="resultContent"></div>
        </div>

        <!-- ì´ë©”ì¼ ì „ì†¡ ì„¹ì…˜ -->
        <div class="email-section" id="emailSection">
            <h3>ğŸ“§ ì´ë©”ì¼ë¡œ ê²°ê³¼ ë°œì†¡</h3>
            <div class="email-form">
                <input type="email" class="email-input" id="emailInput" placeholder="ìˆ˜ì‹ ì ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                <button class="email-btn" id="emailBtn" onclick="sendEmail()">ğŸ“§ ì „ì†¡</button>
            </div>
            <div class="email-msg" id="emailMsg"></div>
        </div>
    </div>

    <script>
        let pollingInterval = null;

        async function startExecution() {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.textContent = 'â³ ì‹¤í–‰ ì¤‘...';

            // UI ì´ˆê¸°í™”
            document.getElementById('resultSection').classList.remove('visible');
            document.getElementById('errorBox').classList.remove('visible');
            document.getElementById('spinnerArea').classList.add('active');
            updateStatus('running', 'ì‹¤í–‰ ì¤‘...');

            try {
                const res = await fetch('/run', { method: 'POST' });
                const data = await res.json();

                if (!data.success) {
                    alert(data.message);
                    resetButton();
                    return;
                }

                // ìƒíƒœ í´ë§ ì‹œì‘ (3ì´ˆ ê°„ê²©)
                pollingInterval = setInterval(checkStatus, 3000);
            } catch (err) {
                updateStatus('error', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                document.getElementById('spinnerArea').classList.remove('active');
                resetButton();
            }
        }

        async function checkStatus() {
            try {
                const res = await fetch('/status');
                const data = await res.json();

                if (data.status === 'completed') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;

                    updateStatus('completed', 'ì™„ë£Œ');
                    document.getElementById('spinnerArea').classList.remove('active');
                    document.getElementById('timeInfo').textContent =
                        `ì‹œì‘: ${data.started_at}  |  ì™„ë£Œ: ${data.completed_at}`;

                    // ê²°ê³¼ í‘œì‹œ
                    document.getElementById('resultContent').textContent = data.result;
                    document.getElementById('resultBadge').textContent = data.completed_at;
                    document.getElementById('resultSection').classList.add('visible');

                    // ì´ë©”ì¼ ì „ì†¡ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('emailSection').classList.add('visible');

                    resetButton();

                } else if (data.status === 'error') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;

                    updateStatus('error', 'ì˜¤ë¥˜ ë°œìƒ');
                    document.getElementById('spinnerArea').classList.remove('active');
                    document.getElementById('errorText').textContent = data.error;
                    document.getElementById('errorBox').classList.add('visible');

                    resetButton();

                } else if (data.status === 'running') {
                    // ê²½ê³¼ ì‹œê°„ í‘œì‹œ
                    if (data.started_at) {
                        const start = new Date(data.started_at);
                        const now = new Date();
                        const diff = Math.floor((now - start) / 1000);
                        const min = Math.floor(diff / 60);
                        const sec = diff % 60;
                        document.getElementById('timeInfo').textContent =
                            `ê²½ê³¼ ì‹œê°„: ${min}ë¶„ ${sec}ì´ˆ`;
                    }
                }
            } catch (err) {
                // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ëŠ” ë¬´ì‹œí•˜ê³  ë‹¤ì‹œ ì‹œë„
            }
        }

        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot ' + state;
            document.getElementById('statusText').textContent = text;
        }

        function resetButton() {
            const btn = document.getElementById('runBtn');
            btn.disabled = false;
            btn.textContent = 'â–¶ ì‹¤í–‰í•˜ê¸°';
        }

        async function sendEmail() {
            const emailInput = document.getElementById('emailInput');
            const emailBtn = document.getElementById('emailBtn');
            const emailMsg = document.getElementById('emailMsg');
            const to = emailInput.value.trim();

            if (!to) {
                showEmailMsg('fail', 'ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            emailBtn.disabled = true;
            emailBtn.textContent = 'â³ ì „ì†¡ ì¤‘...';
            emailMsg.classList.remove('visible');

            try {
                const res = await fetch('/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: to })
                });
                const data = await res.json();

                if (data.success) {
                    showEmailMsg('success', `âœ… ${data.message}`);
                } else {
                    showEmailMsg('fail', `âŒ ${data.message}`);
                }
            } catch (err) {
                showEmailMsg('fail', 'âŒ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            emailBtn.disabled = false;
            emailBtn.textContent = 'ğŸ“§ ì „ì†¡';
        }

        function showEmailMsg(type, text) {
            const el = document.getElementById('emailMsg');
            el.className = 'email-msg visible ' + type;
            el.textContent = text;
        }
    </script>
</body>
</html>
